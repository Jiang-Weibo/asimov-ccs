!!! -*- mode: F90 -*-
!!! vim: set syntax=fortran:
!!!
!!!        FILE: spatial.pf
!!! DESCRIPTION: pFUnit tests of spatial discretisation schemes.

@test
subroutine test_adv_scaling()
  !! Tests that scaling the advection coefficients is equivalent to rescaling the advected variable
  !! before applying the advection scheme, i.e.
  !!
  !!   alpha * adv(phi) = adv(alpha * phi)
  !!
  !! The compiler macro TESTN determines the number of randomised inputs to generate

  use funit
  use iso_fortran_env

  use constants, only : accs_real
  use accs_test_utils, only : accs_test_scale, accs_test_atol

  implicit none

  real(accs_real) :: alpha 
  real(accs_real) :: phiL, phiR, un
  real(accs_real) :: coeffL, coeffR, rhs
  real(accs_real) :: coeffLS, coeffRS, rhsS

  real(accs_real) :: expect
  integer :: iter
  
  do iter = 1, TESTN

     !! Get a scale factor
     call random_number(alpha) 
     alpha = accs_test_scale(alpha)

     !! Create a local field and advecting velocity
     call random_number(phiL)
     call random_number(phiR)
     call random_number(un)

     phiL = accs_test_scale(phiL)
     phiR = accs_test_scale(phiR)
     un = accs_test_scale(un)

     call calc_adv_coeffs(coeffL, coeffR, rhs, phiL, phiR, un)                    ! Unscaled input
     call calc_adv_coeffs(coeffLS, coeffRS, rhsS, alpha * phiL, alpha * phiR, un) ! Scaled input

     expect = alpha * coeffL
     @assertEqual(expect, coeffLS, accs_test_atol(expect))
     expect = alpha * coeffR
     @assertEqual(expect, coeffRS, accs_test_atol(expect))
     expect = alpha * rhs
     @assertEqual(expect, rhsS, accs_test_atol(expect))
     
     @assertEqual(alpha * coeffL, coeffLS)
     @assertEqual(alpha * coeffR, coeffRS)
     @assertEqual(alpha * rhs, rhsS)
     
  end do
  
end subroutine test_adv_scaling
